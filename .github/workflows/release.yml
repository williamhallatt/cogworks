name: Release Cogworks Agent & Skills

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Validate cogworks agent exists
        run: |
          if [ ! -f ".claude/agents/cogworks.md" ]; then
            echo "ERROR: cogworks agent not found at .claude/agents/cogworks.md"
            exit 1
          fi
          echo "✓ cogworks agent found"

      - name: Validate cogworks-* skills exist
        run: |
          SKILLS_DIR=".claude/skills"
          FOUND_SKILLS=()

          # Find all cogworks-* skill directories
          for skill_dir in "$SKILLS_DIR"/cogworks-*/; do
            if [ -d "$skill_dir" ]; then
              skill_name=$(basename "$skill_dir")

              # Check for required SKILL.md file
              if [ ! -f "$skill_dir/SKILL.md" ]; then
                echo "ERROR: SKILL.md not found in $skill_name"
                exit 1
              fi

              FOUND_SKILLS+=("$skill_name")
              echo "✓ $skill_name (SKILL.md present)"
            fi
          done

          if [ ${#FOUND_SKILLS[@]} -eq 0 ]; then
            echo "WARNING: No cogworks-* skills found"
          else
            echo "Found ${#FOUND_SKILLS[@]} cogworks-* skill(s): ${FOUND_SKILLS[@]}"
          fi

      - name: Validate SKILL.md frontmatter syntax
        run: |
          set +e
          ERROR_COUNT=0

          for skill_file in .claude/skills/cogworks-*/SKILL.md; do
            if [ -f "$skill_file" ]; then
              # Extract frontmatter (lines between first and second ---)
              if head -1 "$skill_file" | grep -q "^---$"; then
                # Simple check: file starts with --- and has closing ---
                if tail -n +2 "$skill_file" | grep -q "^---$"; then
                  echo "✓ $skill_file frontmatter syntax valid"
                else
                  echo "ERROR: Missing closing --- in $skill_file"
                  ((ERROR_COUNT++))
                fi
              else
                echo "ERROR: $skill_file does not start with ---"
                ((ERROR_COUNT++))
              fi
            fi
          done

          if [ $ERROR_COUNT -gt 0 ]; then
            echo "Found $ERROR_COUNT SKILL.md validation error(s)"
            exit 1
          fi
          set -e

      - name: Verify cogworks agent dependencies
        run: |
          echo "Checking cogworks agent dependencies..."

          # Look for references to cogworks-encode and cogworks-learn in agent file
          if grep -q "cogworks-encode" ".claude/agents/cogworks.md"; then
            echo "✓ cogworks-encode dependency declared"
          else
            echo "WARNING: cogworks-encode dependency not found in agent (may be referenced differently)"
          fi

          if grep -q "cogworks-learn" ".claude/agents/cogworks.md"; then
            echo "✓ cogworks-learn dependency declared"
          else
            echo "WARNING: cogworks-learn dependency not found in agent (may be referenced differently)"
          fi

      - name: Create release artifact
        run: |
          VERSION=${{ steps.version.outputs.version }}
          ARTIFACT_NAME="cogworks-${VERSION}"

          # Create temporary directory structure
          mkdir -p "${ARTIFACT_NAME}/.claude/agents"
          mkdir -p "${ARTIFACT_NAME}/.claude/skills"
          mkdir -p "${ARTIFACT_NAME}/tests/framework"

          # Copy agent
          cp ".claude/agents/cogworks.md" "${ARTIFACT_NAME}/.claude/agents/"

          # Copy all cogworks-* skills
          for skill_dir in .claude/skills/cogworks-*/; do
            skill_name=$(basename "$skill_dir")
            cp -r "$skill_dir" "${ARTIFACT_NAME}/.claude/skills/"
            echo "Packaged: $skill_name"
          done

          # Copy shared testing framework
          if [ -d "tests/framework" ]; then
            cp -r tests/framework/* "${ARTIFACT_NAME}/tests/framework/"
            echo "Packaged: tests/framework"
          else
            echo "WARNING: tests/framework not found"
          fi

          # Copy documentation and licensing
          cp README.md "${ARTIFACT_NAME}/"
          cp LICENSE "${ARTIFACT_NAME}/"
          cp INSTALL.md "${ARTIFACT_NAME}/" 2>/dev/null || echo "Note: INSTALL.md not found"

          # Copy Codex skills
          if [ -d ".agents/skills" ]; then
            mkdir -p "${ARTIFACT_NAME}/.agents"
            cp -r .agents/skills "${ARTIFACT_NAME}/.agents/skills"
            echo "Packaged: .agents/skills"
          else
            echo "WARNING: .agents/skills not found (Codex support unavailable)"
          fi

          # Copy installation script
          cp install.sh "${ARTIFACT_NAME}/"
          chmod +x "${ARTIFACT_NAME}/install.sh"
          echo "Packaged: install.sh"

          # Generate file list for release notes
          echo "## Release Contents" > release-contents.txt
          echo "" >> release-contents.txt
          echo "### Agent" >> release-contents.txt
          echo "- cogworks" >> release-contents.txt
          echo "" >> release-contents.txt
          echo "### Skills Included" >> release-contents.txt
          for skill_dir in .claude/skills/cogworks-*/; do
            skill_name=$(basename "$skill_dir")
            echo "- ${skill_name}" >> release-contents.txt
          done
          echo "" >> release-contents.txt
          echo "### Codex Skills Included" >> release-contents.txt
          if [ -d ".agents/skills" ]; then
            for skill_dir in .agents/skills/*/; do
              skill_name=$(basename "$skill_dir")
              echo "- ${skill_name}" >> release-contents.txt
            done
          else
            echo "- (none)" >> release-contents.txt
          fi

          # Create archives
          tar -czf "${ARTIFACT_NAME}.tar.gz" "${ARTIFACT_NAME}/"
          zip -r -q "${ARTIFACT_NAME}.zip" "${ARTIFACT_NAME}/"

          echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_ENV

          # Show what was packaged
          echo ""
          echo "=== Release Artifact Created ==="
          echo "Name: ${ARTIFACT_NAME}"
          echo "Archives:"
          ls -lh "${ARTIFACT_NAME}".{tar.gz,zip}
          echo ""
          echo "Contents:"
          tar -tzf "${ARTIFACT_NAME}.tar.gz" | head -20

      - name: Generate changelog from commits
        run: |
          TAG=${{ steps.version.outputs.tag }}

          # Find previous tag (gracefully handle first release)
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || echo "")

          if [ -z "${PREVIOUS_TAG}" ]; then
            echo "No previous tag found — generating changelog from all commits"
            COMMITS=$(git log --format='%s' "${TAG}")
          else
            echo "Generating changelog: ${PREVIOUS_TAG}..${TAG}"
            COMMITS=$(git log --format='%s' "${PREVIOUS_TAG}..${TAG}")
          fi

          # Initialise category arrays
          declare -a CAT_ADD CAT_UPDATE CAT_FIX CAT_REFACTOR CAT_DOCS CAT_TEST CAT_OTHER

          while IFS= read -r msg; do
            [ -z "$msg" ] && continue

            # Extract prefix (everything before the first "/ ")
            if [[ "$msg" =~ ^([a-z]+)/[[:space:]]+(.*) ]]; then
              prefix="${BASH_REMATCH[1]}"
              desc="${BASH_REMATCH[2]}"
            else
              prefix="other"
              desc="$msg"
            fi

            # Capitalise first letter of description
            desc="$(echo "${desc:0:1}" | tr '[:lower:]' '[:upper:]')${desc:1}"

            case "$prefix" in
              add)      CAT_ADD+=("$desc") ;;
              update)   CAT_UPDATE+=("$desc") ;;
              fix)      CAT_FIX+=("$desc") ;;
              refactor) CAT_REFACTOR+=("$desc") ;;
              docs)     CAT_DOCS+=("$desc") ;;
              test)     CAT_TEST+=("$desc") ;;
              *)        CAT_OTHER+=("$desc") ;;
            esac
          done <<< "$COMMITS"

          # Write categorised changelog to file
          {
            echo "## What's Changed"
            echo ""

            declare -A HEADINGS=(
              [ADD]="New Features"
              [UPDATE]="Enhancements"
              [FIX]="Bug Fixes"
              [REFACTOR]="Refactoring"
              [DOCS]="Documentation"
              [TEST]="Testing"
              [OTHER]="Other Changes"
            )

            for key in ADD UPDATE FIX REFACTOR DOCS TEST OTHER; do
              eval "items=(\"\${CAT_${key}[@]}\")"
              if [ ${#items[@]} -gt 0 ]; then
                echo "### ${HEADINGS[$key]}"
                for item in "${items[@]}"; do
                  echo "- ${item}"
                done
                echo ""
              fi
            done
          } > release-notes.md

          # Append release contents section
          {
            echo "---"
            echo ""
            echo "## Release Contents"
            echo ""
            echo "- **cogworks** agent"
            while IFS= read -r skill_line; do
              skill_name=$(echo "$skill_line" | sed 's/^- //')
              case "$skill_name" in
                cogworks-encode|cogworks-learn)
                  echo "- **${skill_name}** skill (required)" ;;
                *)
                  echo "- **${skill_name}** skill" ;;
              esac
            done < <(grep '^- cogworks-' release-contents.txt)
            echo ""
            echo "## Installation"
            echo ""
            echo "Extract the archive and run \`./install.sh\` for guided installation:"
            echo ""
            echo "\`\`\`bash"
            echo "tar -xzf cogworks-{version}.tar.gz"
            echo "cd cogworks-{version}"
            echo "./install.sh"
            echo "\`\`\`"
            echo ""
            echo "Or use non-interactive mode:"
            echo ""
            echo "\`\`\`bash"
            echo "# Install to current project"
            echo "./install.sh --local"
            echo ""
            echo "# Install to personal directory"
            echo "./install.sh --global"
            echo "\`\`\`"
            echo ""
            echo "Codex installs:"
            echo ""
            echo "\`\`\`bash"
            echo "./install.sh --target codex --local"
            echo "./install.sh --target codex --global"
            echo "./install.sh --codex  # legacy global"
            echo "\`\`\`"
            echo ""
            echo "See [INSTALL.md](https://github.com/williamhallatt/cogworks/blob/main/INSTALL.md) for manual installation instructions."
            echo ""
            if [ -n "${PREVIOUS_TAG}" ]; then
              echo "**Full changelog**: https://github.com/williamhallatt/cogworks/compare/${PREVIOUS_TAG}...${TAG}"
            fi
          } >> release-notes.md

          echo "=== Generated Release Notes ==="
          cat release-notes.md

          # Export previous tag for later use
          echo "previous_tag=${PREVIOUS_TAG}" >> $GITHUB_ENV

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          TAG=${{ steps.version.outputs.tag }}
          ARTIFACT_NAME=${{ env.artifact_name }}

          # Create release with both archive types
          gh release create "${TAG}" \
            "${ARTIFACT_NAME}.tar.gz" \
            "${ARTIFACT_NAME}.zip" \
            --title "cogworks v${VERSION}" \
            --notes-file release-notes.md \
            --draft=false

      - name: Verify release creation
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${{ steps.version.outputs.tag }}
          echo "Release created for tag: ${TAG}"
          gh release view "${TAG}" --json assets
