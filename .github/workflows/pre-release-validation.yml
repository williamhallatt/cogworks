name: Pre-Release Validation

on:
  pull_request:
    paths:
      - ".claude/**"
      - "README.md"
      - "INSTALL.md"
      - "LICENSE"
    branches:
      - main
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate cogworks agent
        run: |
          AGENT_FILE=".claude/agents/cogworks.md"

          if [ ! -f "$AGENT_FILE" ]; then
            echo "ERROR: Agent not found: $AGENT_FILE"
            exit 1
          fi

          # Check for YAML frontmatter
          if ! head -1 "$AGENT_FILE" | grep -q "^---$"; then
            echo "ERROR: Agent missing YAML frontmatter (should start with ---)"
            exit 1
          fi

          # Check for closing ---
          if ! awk 'NR>1 && /^---$/ {found=1; exit} END {if (!found) exit 1}' "$AGENT_FILE"; then
            echo "ERROR: Agent YAML frontmatter not closed (missing second ---)"
            exit 1
          fi

          echo "✓ Agent file valid: $AGENT_FILE"

      - name: Validate cogworks-* skills
        run: |
          set +e
          ERROR_COUNT=0
          SKILLS_DIR=".claude/skills"

          if [ ! -d "$SKILLS_DIR" ]; then
            echo "ERROR: Skills directory not found: $SKILLS_DIR"
            exit 1
          fi

          # Check for each cogworks-* skill
          for skill_dir in "$SKILLS_DIR"/cogworks-*/; do
            if [ -d "$skill_dir" ]; then
              skill_name=$(basename "$skill_dir")
              skill_file="$skill_dir/SKILL.md"

              # Check SKILL.md exists
              if [ ! -f "$skill_file" ]; then
                echo "ERROR: $skill_name missing SKILL.md"
                ((ERROR_COUNT++))
                continue
              fi

              # Check frontmatter exists
              if ! head -1 "$skill_file" | grep -q "^---$"; then
                echo "ERROR: $skill_name/SKILL.md missing frontmatter opening"
                ((ERROR_COUNT++))
                continue
              fi

              # Check frontmatter closes
              if ! awk 'NR>1 && /^---$/ {found=1; exit} END {if (!found) exit 1}' "$skill_file"; then
                echo "ERROR: $skill_name/SKILL.md frontmatter not closed"
                ((ERROR_COUNT++))
                continue
              fi

              # Check for required fields in frontmatter
              if ! grep -q "^name:" "$skill_file"; then
                echo "ERROR: $skill_name/SKILL.md missing 'name:' field in frontmatter"
                ((ERROR_COUNT++))
                continue
              fi

              if ! grep -q "^description:" "$skill_file"; then
                echo "ERROR: $skill_name/SKILL.md missing 'description:' field in frontmatter"
                ((ERROR_COUNT++))
                continue
              fi

              echo "✓ $skill_name (valid)"
            fi
          done

          # Warn if no cogworks-* skills found
          if [ ! "$(ls -A "$SKILLS_DIR"/cogworks-* 2>/dev/null)" ]; then
            echo "WARNING: No cogworks-* skills found in $SKILLS_DIR"
          fi

          if [ $ERROR_COUNT -gt 0 ]; then
            echo ""
            echo "Found $ERROR_COUNT validation error(s)"
            exit 1
          fi

          set -e

      - name: Check for required dependencies
        run: |
          AGENT_FILE=".claude/agents/cogworks.md"

          # Check that cogworks-encode is mentioned
          if ! grep -q "cogworks-encode" "$AGENT_FILE"; then
            echo "WARNING: cogworks-encode dependency not found in agent"
          else
            echo "✓ cogworks-encode dependency declared"
          fi

          # Check that cogworks-learn is mentioned
          if ! grep -q "cogworks-learn" "$AGENT_FILE"; then
            echo "WARNING: cogworks-learn dependency not found in agent"
          else
            echo "✓ cogworks-learn dependency declared"
          fi

      - name: Validate test-framework (cogworks-test dependency)
        run: |
          TEST_FRAMEWORK_DIR=".claude/test-framework"

          if [ ! -d "$TEST_FRAMEWORK_DIR" ]; then
            echo "ERROR: test-framework directory not found at $TEST_FRAMEWORK_DIR"
            echo "This is required by the cogworks-test skill"
            exit 1
          fi

          # Check that the directory is not empty
          if [ -z "$(ls -A "$TEST_FRAMEWORK_DIR")" ]; then
            echo "ERROR: test-framework directory is empty"
            exit 1
          fi

          FILE_COUNT=$(find "$TEST_FRAMEWORK_DIR" -type f | wc -l)
          echo "✓ test-framework present ($FILE_COUNT file(s))"

      - name: Behavioral tests (cogworks-*)
        run: |
          python3 .claude/test-framework/scripts/cogworks-test-framework.py behavioral run \
            --skill-prefix cogworks-

      - name: Efficacy validation (SkillsBench methodology)
        run: |
          # Check if efficacy benchmark dataset exists
          if [ ! -d "tests/datasets/efficacy-benchmark" ]; then
            echo "NOTE: Efficacy benchmark dataset not found; skipping efficacy validation"
            echo "To enable efficacy validation, create benchmark tasks in tests/datasets/efficacy-benchmark/"
            exit 0
          fi

          # Count benchmark tasks
          TASK_COUNT=$(find tests/datasets/efficacy-benchmark -maxdepth 1 -type d -name "task-*" | wc -l)

          if [ $TASK_COUNT -eq 0 ]; then
            echo "NOTE: No benchmark tasks found; skipping efficacy validation"
            exit 0
          fi

          echo "Found $TASK_COUNT efficacy benchmark task(s)"
          echo ""

          # For CI, we just validate that the benchmark structure is correct
          # Actual efficacy testing requires generating skills and capturing traces
          for task_dir in tests/datasets/efficacy-benchmark/task-*/; do
            if [ -d "$task_dir" ]; then
              task_name=$(basename "$task_dir")
              echo "Validating benchmark task: $task_name"

              # Check required files
              if [ ! -f "$task_dir/metadata.json" ]; then
                echo "ERROR: $task_name missing metadata.json"
                exit 1
              fi

              if [ ! -f "$task_dir/instruction.md" ]; then
                echo "ERROR: $task_name missing instruction.md"
                exit 1
              fi

              if [ ! -d "$task_dir/sources" ]; then
                echo "ERROR: $task_name missing sources/ directory"
                exit 1
              fi

              if [ ! -d "$task_dir/baseline-traces" ]; then
                echo "ERROR: $task_name missing baseline-traces/ directory"
                exit 1
              fi

              # Check metadata structure
              if ! python3 -c "import json; json.load(open('$task_dir/metadata.json'))" 2>/dev/null; then
                echo "ERROR: $task_name metadata.json is invalid JSON"
                exit 1
              fi

              # Count baseline traces
              BASELINE_COUNT=$(find "$task_dir/baseline-traces" -name "*.json" | wc -l)
              if [ $BASELINE_COUNT -eq 0 ]; then
                echo "WARNING: $task_name has no baseline traces"
              else
                echo "  ✓ $BASELINE_COUNT baseline trace(s)"
              fi

              echo "  ✓ $task_name structure valid"
            fi
          done

          echo ""
          echo "✓ All efficacy benchmark tasks valid"
          echo ""
          echo "To run full efficacy validation:"
          echo "  python3 .claude/test-framework/scripts/cogworks-test-framework.py efficacy run \\"
          echo "    --generated-skill .claude/skills/my-skill \\"
          echo "    --benchmarks-root tests/datasets/efficacy-benchmark"

      - name: Calibration gate
        run: |
          if [ -d "tests/calibration" ] && [ -d "tests/results/latest" ]; then
            python3 .claude/test-framework/scripts/cogworks-test-framework.py calibration run
          else
            echo "Calibration data missing; skipping gate."
          fi

      - name: Validate markdown syntax
        run: |
          set +e
          ERROR_COUNT=0

          # Check for markdown syntax issues (basic checks)
          for md_file in .claude/**/*.md README.md INSTALL.md RELEASES.md; do
            if [ -f "$md_file" ]; then
              # Check for unclosed code blocks
              open_blocks=$(grep -c '```' "$md_file" 2>/dev/null || echo "0")
              if [ $((open_blocks % 2)) -ne 0 ]; then
                echo "WARNING: $md_file may have unclosed code blocks (``` count: $open_blocks)"
              fi
            fi
          done

          set -e

      - name: Summary
        if: success()
        run: |
          echo "✓ All validations passed"
          echo ""
          echo "Ready to create release:"
          echo "  Command: git tag -a v{version} -m 'Release cogworks v{version}'"
          echo "           git push origin v{version}"
