name: Pre-Release Validation

on:
  pull_request:
    paths:
      - ".claude/**"
      - ".agents/**"
      - "tests/**"
      - "scripts/**"
      - "README.md"
      - "INSTALL.md"
      - "TESTING.md"
      - "LICENSE"
    branches:
      - main
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate cogworks agent
        run: |
          AGENT_FILE=".claude/agents/cogworks.md"
          if [ ! -f "$AGENT_FILE" ]; then
            echo "ERROR: Agent not found: $AGENT_FILE"
            exit 1
          fi
          echo "✓ Agent present"

      - name: Validate required Claude skills
        run: |
          for skill in cogworks-encode cogworks-learn; do
            if [ ! -f ".claude/skills/$skill/SKILL.md" ]; then
              echo "ERROR: Missing required skill: $skill"
              exit 1
            fi
            echo "✓ $skill"
          done

      - name: Validate required Codex skills
        run: |
          for skill in cogworks cogworks-encode cogworks-learn; do
            if [ ! -f ".agents/skills/$skill/SKILL.md" ]; then
              echo "ERROR: Missing required Codex skill: $skill"
              exit 1
            fi
            echo "✓ $skill"
          done

      - name: Validate testing framework
        run: |
          TEST_FRAMEWORK_DIR="tests/framework"
          if [ ! -d "$TEST_FRAMEWORK_DIR" ]; then
            echo "ERROR: testing framework directory not found at $TEST_FRAMEWORK_DIR"
            exit 1
          fi
          if [ ! -x "tests/framework/graders/deterministic-checks.sh" ]; then
            echo "ERROR: deterministic checks script missing/executable bit not set"
            exit 1
          fi
          if [ ! -f "tests/framework/scripts/cogworks-eval.py" ]; then
            echo "ERROR: cogworks-eval.py not found"
            exit 1
          fi
          echo "✓ testing framework present"

      - name: Behavioral tests (cogworks-*)
        run: |
          python3 tests/framework/scripts/cogworks-eval.py behavioral run --skill-prefix cogworks-

      - name: Pipeline benchmark smoke test
        run: |
          bash tests/run-pipeline-benchmark-smoke.sh

      - name: Framework black-box tests
        run: |
          bash tests/run-black-box-tests.sh

      - name: Summary
        if: success()
        run: |
          echo "✓ All validations passed"
